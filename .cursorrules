# Project Rules - Patentify

## Stack Tecnologico

- **Framework**: TanStack Start (v1) con TanStack Router e TanStack Query
- **API Layer**: oRPC (`@orpc/server`, `@orpc/client`, `@orpc/openapi`, `@orpc/zod`, `@orpc/tanstack-query`) — procedures + router + OpenAPI
- **UI**: React, Tailwind CSS, shadcn/ui
- **State Management**: Zustand con Immer middleware e Persist middleware
- **Font**: Noto Sans (Google Font)
- **Icone**: Google Icons (SVG locali in `/app/icons`)
- **Database**: Neon DB (progetto "patentify" - ID: dawn-paper-76642524)
- **Auth**: Clerk (`@clerk/tanstack-react-start`)
- **Error Tracking**: Sentry (`@sentry/tanstackstart-react`)
- **Testing**: Vitest
- **Linting/Formatting**: ESLint + Prettier
- **Form**: React Hook Form + Zod
- **Package Manager**: pnpm
- **Node.js**: 24.x
- **TypeScript**: ultima versione

## Regole di Codice

### TypeScript

- **Return types espliciti sempre richiesti**: Ogni funzione deve avere un return type esplicito
- **Strict mode**: TypeScript è configurato in strict mode
- **No `any`**: Evitare l'uso di `any`, preferire tipi specifici o `unknown`

### Mobile-First

- **Design sempre partendo da mobile**: Tutti i componenti devono essere progettati prima per mobile, poi estesi per desktop
- **Breakpoint Tailwind**: Usare `sm:`, `md:`, `lg:` per responsive design
- **Touch-friendly**: Assicurarsi che gli elementi interattivi siano adeguati per touch

### Componenti

- **shadcn/ui**: Usare componenti shadcn/ui quando disponibili
- **Import icone**: Importare icone da `~/icons` (es: `import { LoginIcon } from '~/icons'`)
- **Naming**: Componenti in PascalCase, file in kebab-case o PascalCase
- **Composizione**: Preferire composizione a ereditarietà

### Styling

- **Tailwind CSS**: Usare Tailwind per tutti gli stili
- **Font**: Noto Sans è il font principale, applicato globalmente
- **CSS Variables**: Usare le variabili CSS definite in `globals.css` per i colori
- **Dark mode**: Supportare dark mode usando le classi Tailwind

### Form

- **React Hook Form**: Usare React Hook Form per tutti i form
- **Zod**: Usare Zod per la validazione dei form
- **Resolvers**: Usare `@hookform/resolvers` per integrare Zod con React Hook Form

### Testing

- **Vitest**: Usare Vitest per tutti i test
- **Testing Library**: Usare @testing-library/react per i test dei componenti
- **Coverage**: Mantenere una buona copertura dei test

### Linting e Formatting

- **ESLint**: Sempre rispettare le regole ESLint
- **Prettier**: Sempre formattare il codice con Prettier prima di committare
- **Pre-commit**: Eseguire lint e format prima di ogni commit

### Database

- **Neon DB**: Usare `@neondatabase/serverless` per le query
- **Connection string**: Usare la variabile ambiente `DATABASE_URL`
- **Query**: Usare il client `sql` da `~/lib/db`

### API (oRPC)

- **Architettura a 3 livelli**: Services (business logic) -> Procedures (oRPC, validazione + auth) -> Handlers (RPC + OpenAPI)
- **Services** (`app/server/services/`): Funzioni pure che ricevono parametri espliciti (userId, input). NON gestiscono auth ne validazione. Contengono query SQL e business logic.
- **Schemas** (`app/server/schemas/`): Zod schemas per input/output. Sono il contratto API condiviso. I tipi TypeScript si inferiscono con `z.infer<>`.
- **Procedures** (`app/server/procedures/`): Procedure oRPC sottili che collegano schema + middleware + service. Ogni procedure ha `.route()` per OpenAPI.
- **Router** (`app/server/router.ts`): Router oRPC nested che organizza tutte le procedure per dominio.
- **Client isomorfico** (`app/lib/orpc.ts`): Usa `createIsomorphicFn` per SSR optimization. Esporta `client` e `orpc` (TanStack Query utils).
- **Middleware auth** (`app/server/middleware/auth.ts`): Middleware oRPC che wrappa Clerk `auth()`. Espone `authProcedure` e `publicProcedure`.
- **Handlers**: RPCHandler su `/api/rpc/$` (web), OpenAPIHandler su `/api/v1/$` (mobile).
- **OpenAPI Spec**: Endpoint `/api/v1/spec` genera la spec OpenAPI JSON automaticamente dal router.
- **TanStack Query**: Usare `orpc.dominio.procedura.queryOptions()` / `mutationOptions()` nei componenti client.
- **Import client**: `import { orpc } from '~/lib/orpc'` per query/mutation options, `import { client } from '~/lib/orpc'` per chiamate imperative.
- **Import procedure base**: `import { authProcedure, publicProcedure } from '~/server/middleware/auth'`
- **Errori oRPC**: Usare `ORPCError` con codici standard ('UNAUTHORIZED', 'NOT_FOUND', 'BAD_REQUEST', ecc.)
- **OpenAPI routes**: Ogni procedure deve avere `.route({ method, path, summary })` per generazione spec
- **Output schemas obbligatori**: Ogni procedure deve avere `.output()` per generazione OpenAPI corretta

### Autenticazione

- **Clerk**: Usare Clerk come provider di autenticazione
- **Web**: Session cookies gestite automaticamente da Clerk
- **Mobile**: Bearer token JWT inviato in Authorization header
- **Middleware oRPC**: `authProcedure` da `~/server/middleware/auth` per procedure autenticate
- **Procedure pubbliche**: `publicProcedure` da `~/server/middleware/auth` per endpoint senza auth
- **Webhook Clerk**: `app/routes/api/webhooks/clerk.ts` per sync utenti su DB

### Error Tracking (Sentry)

- **SDK**: `@sentry/tanstackstart-react` per client e server
- **Init server**: `instrument.server.mjs` (importato via `NODE_OPTIONS='--import ./instrument.server.mjs'`)
- **Init client**: In `app/router.tsx` con `Sentry.init()` condizionato a `!router.isServer`
- **Browser tracing**: `Sentry.tanstackRouterBrowserTracingIntegration(router)` per tracing automatico delle navigazioni
- **Database errors**: Usare `captureDatabaseError()` da `~/lib/db` per errori DB critici nei services
- **oRPC error interceptor**: Usare `onError` interceptor negli handler oRPC per catturare errori non gestiti

### Routing

- **TanStack Start**: Usare file-system routing di TanStack Start
- **Route files**: Creare file route in `app/` directory
- **Navigation**: Usare `useNavigate` da `@tanstack/react-router`

### State Management

- **Zustand**: Usare Zustand per lo stato globale persistente
- **Store location**: Lo store è in `app/store/` con pattern slices
- **Import**: `import { useAppStore } from '~/store'`
- **Immer middleware**: Usato per updates immutabili (mutare direttamente lo stato in `set()`)
- **Persist middleware**: Usato per salvare lo stato in localStorage
- **SSR/Hydration**: Lo store usa `skipHydration: true`, rehydration gestita in `__root.tsx`
- **Slices**: Organizzazione modulare in `app/store/slices/`
- **Quando usare Zustand**: Stato che deve persistere tra sessioni (filtri, preferenze, sezioni aperte)
- **Quando usare useState**: Stato locale temporaneo (modali, loading, form non persistenti)

### Versioning

- **Conventional Commits**: Usare Conventional Commits per i messaggi di commit
- **Semantic Versioning**: Il versioning semantico è gestito automaticamente da GitHub Actions
- **Pattern commit**:
  - `feat:` per nuove funzionalità (minor version bump)
  - `fix:` per bug fix (patch version bump)
  - `BREAKING CHANGE:` o `!` per breaking changes (major version bump)

## Best Practices

1. **Componenti riutilizzabili**: Creare componenti riutilizzabili in `app/components/`
2. **Utilities**: Mettere funzioni di utilità in `app/lib/`
3. **Type safety**: Mantenere la type safety in tutto il codice
4. **Error handling**: Gestire sempre gli errori in modo appropriato
5. **Performance**: Ottimizzare per le performance, specialmente su mobile
6. **Accessibility**: Assicurarsi che l'app sia accessibile
7. **Documentation**: Documentare funzioni e componenti complessi

## File Structure

- `app/` - Codice sorgente principale
- `app/components/` - Componenti React
- `app/lib/` - Utilities e helpers
- `app/lib/orpc.ts` - Client isomorfico oRPC (SSR + client)
- `app/server/` - Layer API
- `app/server/services/` - Business logic (funzioni pure, query DB)
- `app/server/schemas/` - Zod schemas input/output (contratto API)
- `app/server/procedures/` - Procedure oRPC
- `app/server/middleware/` - Middleware oRPC (auth, ecc.)
- `app/server/router.ts` - Router oRPC completo
- `app/routes/api/rpc.$.ts` - RPCHandler per web app
- `app/routes/api/v1.$.ts` - OpenAPIHandler per mobile + spec
- `app/store/` - Store Zustand (slices, hooks, tipi)
- `app/icons/` - Icone SVG locali
- `app/styles/` - Stili globali
- `tests/` - Test files
- `public/` - File statici

## Import Aliases

- `~/` - Alias per `app/`
- `@/` - Alias per root directory

## Note Importanti

- Tutte le librerie devono essere all'ultima versione disponibile
- Non committare `.env.local`, solo `.env.example`
- Il font Noto Sans è importato da Google Fonts
- Le icone Google Icons sono scaricate come SVG locali e organizzate in `/app/icons` con export centralizzato
